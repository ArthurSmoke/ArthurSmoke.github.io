<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=cn dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Pytest Fixture Note - 洋葱的自留地</title>
<meta name=theme-color><meta name=description content="最近在学习实践自动化相关的知识，最终选用 pytest 来组织测试用例。
本文是 pytest 学习笔记的第一篇。"><meta name=author content="洋葱的自留地"><link rel="preload stylesheet" as=style href=https://xiaolong.fun/main.min.css><link rel=preload as=image href=https://xiaolong.fun/theme.png><script defer src=https://xiaolong.fun/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://xiaolong.fun/favicon.ico><link rel=apple-touch-icon href=https://xiaolong.fun/apple-touch-icon.png><meta name=generator content="Hugo 0.137.0"><meta itemprop=name content="Pytest Fixture Note"><meta itemprop=description content="最近在学习实践自动化相关的知识，最终选用 pytest 来组织测试用例。
本文是 pytest 学习笔记的第一篇。"><meta itemprop=datePublished content="2019-03-16T00:00:00+00:00"><meta itemprop=dateModified content="2019-03-16T00:00:00+00:00"><meta itemprop=wordCount content="1117"><meta itemprop=keywords content="笔记,测试"><meta property="og:url" content="https://xiaolong.fun/posts/pytest-fixture-note/"><meta property="og:site_name" content="洋葱的自留地"><meta property="og:title" content="Pytest Fixture Note"><meta property="og:description" content="最近在学习实践自动化相关的知识，最终选用 pytest 来组织测试用例。
本文是 pytest 学习笔记的第一篇。"><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-16T00:00:00+00:00"><meta property="article:modified_time" content="2019-03-16T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pytest Fixture Note"><meta name=twitter:description content="最近在学习实践自动化相关的知识，最终选用 pytest 来组织测试用例。
本文是 pytest 学习笔记的第一篇。"><link rel=canonical href=https://xiaolong.fun/posts/pytest-fixture-note/></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center"><div class="relative z-50 ltr:mr-auto rtl:ml-auto flex items-center"><a class="-translate-y-[1px] text-2xl font-medium" href=https://xiaolong.fun/>洋葱的自留地</a><div class="btn-dark text-[0] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 ltr:-mr-8 rtl:-ml-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"><article><header class=mb-14><h1 class="!my-0 pb-2.5">Pytest Fixture Note</h1><div class="text-xs antialiased opacity-60"><time>Mar 16, 2019</time></div></header><section><p>最近在学习实践自动化相关的知识，最终选用 pytest 来组织测试用例。</p><p>本文是 pytest 学习笔记的第一篇。</p><p>Fixture 是 pytest 中的一个基本概念，可以简单理解为在测试用例前需要执行的内容，我用来初始化环境、准备数据等工作。</p><h2 id=fixture>Fixture</h2><p>在被当做 fixture 的函数前面加上<code> @pytest.fixture</code>来定义一个 Fixture</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@pytest.fixture</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>before</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>before each test&#39;</span>)
</span></span></code></pre></div><h3 id=scope>Scope</h3><ul><li>function：每个 test 都运行，默认是 function 的 scope</li><li>class：每个 class 的所有 test 只运行一次</li><li>module：每个 module 的所有 test 只运行一次</li><li>session：每个 session 只运行一次</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@pytest.fixture</span>(scope<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;module&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>smtp</span>():
</span></span><span style=display:flex><span>    smtp <span style=color:#f92672>=</span> smtplib<span style=color:#f92672>.</span>SMTP(<span style=color:#e6db74>&#34;smtp.gmail.com&#34;</span>, <span style=color:#ae81ff>587</span>, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>yield</span> smtp
</span></span><span style=display:flex><span>    <span style=color:#75715e>#yield下面是teardown内容</span>
</span></span><span style=display:flex><span>    smtp<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_ehlo</span>(smtp):
</span></span><span style=display:flex><span><span style=color:#75715e>#fixture的function名称，可以直接作为参数，传给需要使用它的测试样例。 在使用时，smtp并非前面定义的function，而是function的返回值，即smtplib.SMTP</span>
</span></span><span style=display:flex><span>    response, msg <span style=color:#f92672>=</span> smtp<span style=color:#f92672>.</span>ehlo()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> response <span style=color:#f92672>==</span> <span style=color:#ae81ff>250</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;smtp.gmail.com&#34;</span> <span style=color:#f92672>in</span> msg
</span></span></code></pre></div><h3 id=conftestpy>conftest.py</h3><p><code>conftest.py</code>是 pytest 的默认配置文件，可以在其中放公用的 fixture 或 plugin。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tests
</span></span><span style=display:flex><span>├── conftest.py
</span></span><span style=display:flex><span>├── test_a.py
</span></span><span style=display:flex><span>├── test_b.py
</span></span><span style=display:flex><span>└── sub
</span></span><span style=display:flex><span>    ├── __init__.py
</span></span><span style=display:flex><span>    ├── conftest.py
</span></span><span style=display:flex><span>    ├── test_c.py
</span></span><span style=display:flex><span>    └── test_d.py
</span></span></code></pre></div><p><code>conftest.py</code>遵守就近原则，会优先使用层级最近的 conftest 中定义的 Fixture。同时外层的测试用例 a,b 不能使用内层<code>conftest.py</code>中定义的 fixture</p><h2 id=use-fixture>Use Fixture</h2><h3 id=1-当做参数直接调用>1. 当做参数直接调用</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@pytest.fixture</span>(scope<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;module&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>smtp</span>():
</span></span><span style=display:flex><span>    smtp <span style=color:#f92672>=</span> smtplib<span style=color:#f92672>.</span>SMTP(<span style=color:#e6db74>&#34;smtp.gmail.com&#34;</span>, <span style=color:#ae81ff>587</span>, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>yield</span> smtp
</span></span><span style=display:flex><span>    smtp<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_ehlo</span>(smtp):
</span></span><span style=display:flex><span>    response, msg <span style=color:#f92672>=</span> smtp<span style=color:#f92672>.</span>ehlo()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> response <span style=color:#f92672>==</span> <span style=color:#ae81ff>250</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;smtp.gmail.com&#34;</span> <span style=color:#f92672>in</span> msg
</span></span></code></pre></div><p>fixture 的 function 名称，可以直接作为参数，传给需要使用它的测试样例。 在使用时，<code>smtp</code>并非前面定义的 function，而是 function 的返回值，即<code>smtplib.SMTP</code></p><h3 id=2-在函数前用-fixture-decorator-调用>2. 在函数前用 Fixture Decorator 调用</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@pytest.mark.usefixtures</span>(<span style=color:#e6db74>&#34;before&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_1</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;test_1()&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Test1</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@pytest.mark.usefixtures</span>(<span style=color:#e6db74>&#34;before&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_3</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;test_1()&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@pytest.mark.usefixtures</span>(<span style=color:#e6db74>&#34;before&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_4</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;test_2()&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@pytest.mark.usefixtures</span>(<span style=color:#e6db74>&#34;before&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Test2</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_5</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;test_1()&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_6</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;test_2()&#39;</span>)
</span></span></code></pre></div><h3 id=3-用-autouse-调用-fixture>3. 用 Autouse 调用 Fixture</h3><p>fixture decorator 一个 optional 的参数是<code>autouse</code>, 默认设置为 False。
当默认为 False，就可以选择用上面两种方式来试用 fixture。
当设置为 True 时，在一个 session 内的所有的 test 都会自动调用这个 fixture。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@pytest.fixture</span>(autouse<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>before</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>before each test&#39;</span>)
</span></span></code></pre></div><h2 id=finallizer>Finallizer</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@pytest.fixture</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>smtp</span>(request):
</span></span><span style=display:flex><span>    smtp <span style=color:#f92672>=</span> smtplib<span style=color:#f92672>.</span>SMTP(<span style=color:#e6db74>&#34;smtp.gmail.com&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fin</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e>#释放函数</span>
</span></span><span style=display:flex><span>        print (<span style=color:#e6db74>&#34;teardown smtp&#34;</span>)
</span></span><span style=display:flex><span>        smtp<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    request<span style=color:#f92672>.</span>addfinalizer(fin)
</span></span><span style=display:flex><span>    <span style=color:#75715e>#测试完成后调用</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> smtp
</span></span></code></pre></div><p>通过<code>addfinallizer()</code>注册释放函数</p><h2 id=parametrizing>Parametrizing</h2><p>fixture 可以通过参数化来循环使用预设的参数</p><h3 id=1-params>1. params</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@pytest.fixture</span>(params<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;smtp.gmail.com&#34;</span>, <span style=color:#e6db74>&#34;mail.python.org&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>smtp</span>(request):
</span></span><span style=display:flex><span>    smtp <span style=color:#f92672>=</span> smtplib<span style=color:#f92672>.</span>SMTP(request<span style=color:#f92672>.</span>param, <span style=color:#ae81ff>587</span>, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>yield</span> smtp
</span></span><span style=display:flex><span>    print (<span style=color:#e6db74>&#34;finalizing </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> smtp)
</span></span><span style=display:flex><span>    smtp<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><p>在<code> @pytest.fixture</code>中，指定参数<code>params</code>，就可以利用特殊对象（<code>request</code>）来引用<code>request.param</code>。 使用以上带参数的 smtp 的测试样例，都会被执行两次。</p><h3 id=2-pytestmarkparametrize>2. @pytest.mark.parametrize</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(a, b):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> a <span style=color:#f92672>+</span> b
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@pytest.mark.parametrize</span>(<span style=color:#e6db74>&#34;test_input, expected&#34;</span>, [
</span></span><span style=display:flex><span>    ([<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>], <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>    ([<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>], <span style=color:#ae81ff>4</span>),
</span></span><span style=display:flex><span>    ([<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>], <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_add</span>(test_input, expected):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> expected <span style=color:#f92672>==</span> add(test_input[<span style=color:#ae81ff>0</span>], test_input[<span style=color:#ae81ff>1</span>])
</span></span></code></pre></div><h2 id=build-in-fixture>Build-in Fixture</h2><p><code>pytest --fixtures</code>可以列出所有可用的 fixture，包括内置的、插件中的、以及当前项目定义的。</p><h3 id=capsys>capsys</h3><p><code>capsys</code>可以捕捉测试 function 的标准输出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_print</span>(capsys):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;hello&#39;</span>)
</span></span><span style=display:flex><span>    out, err <span style=color:#f92672>=</span> capsys<span style=color:#f92672>.</span>readouterr()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> <span style=color:#e6db74>&#39;hello&#39;</span> <span style=color:#f92672>==</span> out
</span></span></code></pre></div><h3 id=tmpdir>tmpdir</h3><p><code>tmpdir</code>则可以自动创建临时文件夹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_path</span>(tmpdir):
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> py._path.local <span style=color:#f92672>import</span> LocalPath
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> isinstance(tmpdir, LocalPath)
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> os.path <span style=color:#f92672>import</span> isdir
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> isdir(str(tmpdir))
</span></span></code></pre></div><h2 id=参考>参考</h2><ul><li><a href=http://note.qidong.name/2018/01/pytest-fixture/>《Pytest 中的 Fixture》</a></li><li><a href=http://senarukana.github.io/2015/05/29/pytest-fixture/>《Pytest Fixture》</a></li><li><a href=https://docs.pytest.org/en/latest/fixture.html#fixture-finalization-executing-teardown-code>《pytest fixtures: explicit, modular, scalable》</a></li></ul></section><footer class="mt-12 flex flex-wrap"><a class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]" href=https://xiaolong.fun/tags/%E6%B5%8B%E8%AF%95>测试</a>
<a class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]" href=https://xiaolong.fun/tags/pytest>Pytest</a></footer><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg !leading-[1.2] *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://xiaolong.fun/posts/driver-note/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>驾考宝典</span></a></nav></article></main><footer class="mx-auto flex h-[4.5rem] max-w-[--w] items-center px-8 text-xs uppercase tracking-wider opacity-60"><div class=mr-auto>© 2024, Arthur Feng</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>hugo-paper</a></footer></body></html>